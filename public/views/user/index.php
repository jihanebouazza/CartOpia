<?php
require '../../inc/header.php';

if (!is_logged_in()) {
  redirect('views/auth/login');
}

$user_id = user('id');
$order_number = getNumberOfOrdersByUser($user_id);
$wishlist_number = count($_SESSION['wishlist'] ?? []);
$cart_number = count($_SESSION['cart'] ?? []);
$categorySpending = getUserSpendingPerCategory($user_id);
$orderStatusCounts = getOrderStatusCounts($user_id);
?>
<main>
  <?php require '../../inc/user_sidebar.php'; ?>
  <div class="user-content">
    <h2>Bonjour, <?= user('firstname') ?></h2>
    <div class="user-dashboard-numbers">
      <div class="number">
        <div class="number-div">
          <svg class="icon-dahsboard" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <defs>
              <style>
                .cls-1 {
                  fill: #dad7e5
                }

                .cls-4 {
                  fill: #919191
                }
              </style>
            </defs>
            <g id="Shopping_List" data-name="Shopping List">
              <path class="cls-1" d="M36 23v19a5 5 0 0 1-10 0v-2H8V10h21.81l-.54 8.75a4 4 0 0 0 4 4.25z" />
              <path d="M36 23v19a5 5 0 0 1-5 5H14V10h15.81l-.54 8.75a4 4 0 0 0 4 4.25z" style="fill:#edebf2" />
              <path d="M31 47H7a6 6 0 0 1-6-6v-1h25c0 2.15-.22 3.84 1.46 5.54A5 5 0 0 0 31 47z" style="fill:#c6c3d8" />
              <path class="cls-1" d="M28 46H18a4 4 0 0 1-4-4v-2h12c0 2.28-.24 4.35 2 6z" />
              <path class="cls-4" d="M13 23a1 1 0 0 0-2 0 1 1 0 0 0 2 0M13 28a1 1 0 0 0-2 0 1 1 0 0 0 2 0M26 24H16a1 1 0 0 1 0-2h10a1 1 0 0 1 0 2zM13 18a1 1 0 0 0-2 0 1 1 0 0 0 2 0M26 19H16a1 1 0 0 1 0-2h10a1 1 0 0 1 0 2zM32 29H16a1 1 0 0 1 0-2h16a1 1 0 0 1 0 2zM13 33a1 1 0 0 0-2 0 1 1 0 0 0 2 0M32 34H16a1 1 0 0 1 0-2h16a1 1 0 0 1 0 2z" />
              <path d="M46.73 18.75a4 4 0 0 1-4 4.25h-9.47a4 4 0 0 1-4-4.25c.62-10 .51-8.33.61-9.87a2 2 0 0 1 2-1.88h12.25a2 2 0 0 1 2 1.88z" style="fill:#fc6" />
              <path class="cls-1" d="M36 23v1h-3.74a4 4 0 0 1-4-4.25c.61-9.84.51-8.33.6-9.75h.94l-.54 8.75a4 4 0 0 0 4 4.25z" />
              <path d="M46.2 21H38a4 4 0 0 1-4-4V7h10.12a2 2 0 0 1 2 1.88C46.75 19 47 19.58 46.2 21z" style="fill:#ffde76" />
              <path d="M41 9V6a3 3 0 0 0-6 0v3a1 1 0 0 1-2 0V6a5 5 0 0 1 10 0v3a1 1 0 0 1-2 0z" style="fill:#a87e6b" />
            </g>
          </svg>
          <p>Nombre de commandes</p>
        </div>
        <div class="digit"><?= $order_number ?></div>
        <div class="digit"><a href="<?= ROOT ?>/views/user/orders.php">Voir l'historique des commandes</a></div>
      </div>
      <div class="number">
        <div class="number-div">
          <svg class="icon-dahsboard" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <defs>
              <style>
                .cls-2 {
                  fill: #edebf2
                }

                .cls-3 {
                  fill: #7c7d7d
                }

                .cls-4 {
                  fill: #c6c3d8
                }

                .cls-9 {
                  fill: #374f68
                }

                .cls-10 {
                  fill: #425b72
                }
              </style>
            </defs>
            <g id="shooping_cart" data-name="shooping cart">
              <path d="M47 15c-3 17.29-2.52 14.24-3 17H16l-2.35-18.78z" style="fill:#dad7e5" />
              <path class="cls-2" d="m47 15-2.65 15H21.53a4 4 0 0 1-4-3.5l-1.61-13.16z" />
              <path class="cls-3" d="M44 39c-30.2 0-28.4.21-28.83-.45a6.39 6.39 0 0 1-.17-6.78L12.23 9.88a1 1 0 0 0-1-.88H9a1 1 0 0 1 0-2h2.23a3 3 0 0 1 3 2.63c3 24.29 2.92 22.48 2.62 22.92a4.41 4.41 0 0 0-.28 4.45H44a1 1 0 0 1 0 2z" />
              <path class="cls-4" d="M29 27v-8a1 1 0 0 1 2 0v8a1 1 0 0 1-2 0zM35 26.88l1-8a1 1 0 0 1 2 .24l-1 8a1 1 0 0 1-2-.24zM23 27.12l-1-8a1 1 0 0 1 2-.24l1 8a1 1 0 0 1-2 .24z" />
              <path d="M38.75 14.56 31 14.15V9a5 5 0 0 1 7.75 5.56z" style="fill:#6fabe6" />
              <path d="m39 12.57-4.08-.22a2 2 0 0 1-1.89-2V8.1A5 5 0 0 1 39 12.57z" style="fill:#82bcf4" />
              <path d="M31 4v10.15l-10-.54V4z" style="fill:#db5669" />
              <path d="M31 4v8l-5.16-.28a3 3 0 0 1-2.84-3V4z" style="fill:#f26674" />
              <path class="cls-9" d="M9 7v2a1 1 0 0 1-1 1H3a2 2 0 0 1-1-3.74c.61-.35.51-.26 6-.26a1 1 0 0 1 1 1z" />
              <path class="cls-10" d="M9 7v1H4a2 2 0 0 1-2-1.74c.61-.35.51-.26 6-.26a1 1 0 0 1 1 1z" />
              <path class="cls-9" d="M20 41a3 3 0 1 1-3.87-2.87A3 3 0 0 1 20 41z" />
              <circle class="cls-9" cx="40" cy="41" r="3" />
              <path class="cls-10" d="M19.87 41.87a3 3 0 0 1-3.74-3.74 3 3 0 0 1 3.74 3.74zM42.87 41.87a3 3 0 0 1-3.74-3.74 3 3 0 0 1 3.74 3.74z" />
              <path class="cls-2" d="M16.29 40.29a1 1 0 0 1 1.42 1.42 1 1 0 0 1-1.42-1.42zM39.29 40.29a1 1 0 0 1 1.42 1.42 1 1 0 0 1-1.42-1.42z" />
              <path class="cls-3" d="M17 31h26a1 1 0 0 1 0 2H17a1 1 0 0 1 0-2z" />
            </g>
          </svg>
          <p>Nombre de produits dans le panier</p>
        </div>
        <div class="digit"><?= $cart_number ?></div>
        <div class="digit"><a href="<?= ROOT ?>/views/products/cart.php">Voir le panier </a></div>
      </div>
      <div class="number">
        <div class="number-div">
          <svg class="icon-dahsboard" version="1.1" id="ecommerce_1_" xmlns="http://www.w3.org/2000/svg" x="0" y="0" viewBox="0 0 115 115" style="enable-background:new 0 0 115 115" xml:space="preserve">
            <style>
              .st0 {
                fill: #ffeead
              }

              .st1 {
                fill: #c9b77d
              }

              .st2 {
                fill: #99734a
              }
            </style>
            <g id="shopping_list_1_">
              <path class="st0" d="M86.977 7.592H26.576a9.49 9.49 0 0 0-9.49 9.49v2.006h-.046v75.778l.563.565a2.284 2.284 0 0 0 3.23.004l2.08-2.075a2.157 2.157 0 0 1 1.523-.629h1.213c.573 0 1.123.228 1.528.634l2.076 2.082a2.284 2.284 0 0 0 3.23.004L34.54 93.4a2.282 2.282 0 0 1 1.616-.667l1.082.001a2.284 2.284 0 0 1 1.614.671l2.052 2.057a2.284 2.284 0 0 0 3.23.004l2.057-2.052a2.282 2.282 0 0 1 1.616-.667l1.082.002a2.284 2.284 0 0 1 1.614.671l2.051 2.057a2.284 2.284 0 0 0 3.23.004l2.057-2.051a2.282 2.282 0 0 1 1.616-.667h.157a2.072 2.072 0 0 1 2.069 2.072V97.4c0 .564.051 1.114.132 1.651.009.058.014.117.023.174.085.512.21 1.007.363 1.488.022.07.043.139.066.208.162.475.355.934.578 1.372.027.054.056.107.084.16.238.448.503.877.8 1.277l.046.059c1.286 1.707 3.073 3.156 5.115 3.632.42.098.847-.032 1.286 0h.111c4.74-.342 8.493-4.695 8.493-10.021V19.09h-.005v-1.524c-.002-5.218 3.601-9.48 8.202-9.974z" />
              <path d="M87.377 7.556v-.013c-.019.001-.037.005-.055.006-.019-.001-.037-.005-.056-.006v.012c-.098.007-.192.026-.289.036-4.601.495-8.204 4.756-8.204 9.973v1.524h.005v53.396H95.87v-54.92c0-5.326-3.753-9.667-8.493-10.008z" style="fill:#aa9865" />
              <path class="st1" d="m63.774 103.788-.046-.059c-.297-.4-.561-.829-.8-1.277l-.084-.16a10.424 10.424 0 0 1-.578-1.372c-.023-.069-.044-.139-.066-.208a10.665 10.665 0 0 1-.363-1.488c-.01-.058-.014-.117-.023-.174a11.067 11.067 0 0 1-.132-1.651v-2.565c0-1.143-.926-2.07-2.069-2.072h-.157a2.282 2.282 0 0 0-1.616.667l-2.057 2.051a2.284 2.284 0 0 1-3.23-.004l-2.051-2.057a2.284 2.284 0 0 0-1.614-.671l-1.082-.002a2.282 2.282 0 0 0-1.616.667l-2.057 2.052a2.284 2.284 0 0 1-3.23-.004l-2.052-2.057a2.284 2.284 0 0 0-1.614-.671l-1.082-.001a2.282 2.282 0 0 0-1.616.667l-2.057 2.051a2.284 2.284 0 0 1-3.23-.004l-2.076-2.082a2.159 2.159 0 0 0-1.528-.634h-1.213c-.571 0-1.118.226-1.523.629l-2.08 2.075a2.284 2.284 0 0 1-3.23-.004l-.563-.565-1.488-1.492a2.286 2.286 0 0 0-1.614-.671l-1.082-.001a2.282 2.282 0 0 0-1.616.667L9.183 95.42a2.284 2.284 0 0 1-3.23-.004l-2.052-2.057A2.284 2.284 0 0 0 0 94.969v.583c-.009 6.503 5.256 11.86 11.758 11.868h57.131c-2.041-.476-3.829-1.925-5.115-3.632zM66.108 75.453l-.574.764c-1.34 1.785-3.329 6.989-2.976 10.071.006.054.011.107.019.16.053.362.139.691.267.979.021.047.047.088.071.133.145.282.32.532.558.71.143.108.304.187.475.251.059.022.124.033.186.05.117.032.235.06.362.076.083.01.169.013.256.016a3.731 3.731 0 0 0 .662-.031c.108-.014.219-.034.331-.055.124-.024.246-.047.374-.079.084-.021.171-.049.257-.074 2.993-.868 6.861-3.85 8.096-5.495l.574-.764 3.733-4.972V58.578L66.108 75.453z" />
              <path class="st2" d="M65.983 27.175H33.796c-.797 0-1.449.652-1.449 1.449v.273c0 .797.652 1.449 1.449 1.449h32.187c.797 0 1.449-.652 1.449-1.449v-.273c0-.797-.652-1.449-1.449-1.449zM27.85 27.175h-1.929c-.844 0-1.534.69-1.534 1.534v.104c0 .844.69 1.534 1.534 1.534h1.929c.844 0 1.534-.69 1.534-1.534v-.104c0-.844-.69-1.534-1.534-1.534zM65.983 34.198H33.796c-.797 0-1.449.652-1.449 1.449v.273c0 .797.652 1.449 1.449 1.449h32.187c.797 0 1.449-.652 1.449-1.449v-.273c0-.797-.652-1.449-1.449-1.449zM27.85 34.198h-1.929c-.844 0-1.534.69-1.534 1.534v.104c0 .844.69 1.534 1.534 1.534h1.929c.844 0 1.534-.69 1.534-1.534v-.104c0-.844-.69-1.534-1.534-1.534zM65.983 41.221H33.796c-.797 0-1.449.652-1.449 1.449v.273c0 .797.652 1.449 1.449 1.449h32.187c.797 0 1.449-.652 1.449-1.449v-.273c0-.797-.652-1.449-1.449-1.449zM27.85 41.221h-1.929c-.844 0-1.534.69-1.534 1.534v.104c0 .844.69 1.534 1.534 1.534h1.929c.844 0 1.534-.69 1.534-1.534v-.104c0-.844-.69-1.534-1.534-1.534zM65.983 48.244H33.796c-.797 0-1.449.652-1.449 1.449v.273c0 .797.652 1.449 1.449 1.449h32.187c.797 0 1.449-.652 1.449-1.449v-.273c0-.797-.652-1.449-1.449-1.449zM27.85 48.244h-1.929c-.844 0-1.534.69-1.534 1.534v.104c0 .844.69 1.534 1.534 1.534h1.929c.844 0 1.534-.69 1.534-1.534v-.104c0-.844-.69-1.534-1.534-1.534zM65.983 55.267H33.796c-.797 0-1.449.652-1.449 1.449v.273c0 .797.652 1.449 1.449 1.449h32.187c.797 0 1.449-.652 1.449-1.449v-.273c0-.797-.652-1.449-1.449-1.449zM27.85 55.267h-1.929c-.844 0-1.534.69-1.534 1.534v.104c0 .844.69 1.534 1.534 1.534h1.929c.844 0 1.534-.69 1.534-1.534v-.104c0-.844-.69-1.534-1.534-1.534zM65.983 62.29H33.796c-.797 0-1.449.652-1.449 1.449v.273c0 .797.652 1.449 1.449 1.449h32.187c.797 0 1.449-.652 1.449-1.449v-.273c0-.797-.652-1.449-1.449-1.449zM27.85 62.29h-1.929c-.844 0-1.534.69-1.534 1.534v.104c0 .844.69 1.534 1.534 1.534h1.929c.844 0 1.534-.69 1.534-1.534v-.104c0-.844-.69-1.534-1.534-1.534zM65.983 69.313H33.796c-.797 0-1.449.652-1.449 1.449v.273c0 .797.652 1.449 1.449 1.449h32.187c.797 0 1.449-.652 1.449-1.449v-.273c0-.797-.652-1.449-1.449-1.449zM27.85 69.313h-1.929c-.844 0-1.534.69-1.534 1.534v.104c0 .844.69 1.534 1.534 1.534h1.929c.844 0 1.534-.69 1.534-1.534v-.104c0-.844-.69-1.534-1.534-1.534zM65.983 76.336H33.796c-.797 0-1.449.652-1.449 1.449v.273c0 .797.652 1.449 1.449 1.449h32.187c.797 0 1.449-.652 1.449-1.449v-.273c0-.797-.652-1.449-1.449-1.449zM27.85 76.336h-1.929c-.844 0-1.534.69-1.534 1.534v.104c0 .844.69 1.534 1.534 1.534h1.929c.844 0 1.534-.69 1.534-1.534v-.104c0-.843-.69-1.534-1.534-1.534zM65.983 83.359H33.796c-.797 0-1.449.652-1.449 1.449v.273c0 .797.652 1.449 1.449 1.449h32.187c.797 0 1.449-.652 1.449-1.449v-.273c0-.797-.652-1.449-1.449-1.449z" />
              <g>
                <path d="M65.983 83.359h-3.232c-.197 1.059-.29 2.077-.192 2.929.006.054.011.107.019.16.004.031.018.053.023.083h3.383c.797 0 1.449-.652 1.449-1.449v-.273a1.455 1.455 0 0 0-1.45-1.45z" style="fill:#825e3b" />
              </g>
              <g>
                <path class="st2" d="M27.85 83.359h-1.929c-.844 0-1.534.69-1.534 1.534v.104c0 .844.69 1.534 1.534 1.534h1.929c.844 0 1.534-.69 1.534-1.534v-.104c0-.843-.69-1.534-1.534-1.534z" />
              </g>
              <g>
                <path d="M112.677 13.957c-2.458-1.845-5.874-1.484-7.592.804L62.671 71.25c-1.718 2.288-4.519 10.207-2.061 12.053 2.458 1.845 9.281-3.054 10.999-5.342l42.413-56.488c1.718-2.289 1.112-5.67-1.345-7.516z" style="fill:#ff6f69" />
                <path class="st0" d="m63.245 70.486-.573.764c-1.718 2.288-4.519 10.207-2.061 12.053 2.458 1.845 9.281-3.054 10.999-5.342l.574-.764-8.939-6.711z" />
                <path class="st2" d="M59.84 78.574c-.364 2.074-.272 3.951.769 4.733 1.041.783 2.868.347 4.756-.581l-5.525-4.152z" />
                <path d="M112.677 13.957c-2.458-1.845-5.874-1.484-7.592.804l-4.552 6.062 8.938 6.711 4.552-6.062c1.717-2.288 1.111-5.669-1.346-7.515z" style="fill:#96ceb4" />
                <path transform="rotate(-53.101 105.754 23.172)" class="st0" d="M104.498 17.582h2.522v11.176h-2.522z" />
              </g>
            </g>
          </svg>
          <p>Nombre de produits dans la liste de souhaits</p>
        </div>
        <div class="digit"><?= $wishlist_number ?></div>
        <div class="digit"><a href="<?= ROOT ?>/views/products/wishlist.php">Voir la liste de souhaits </a></div>
      </div>
    </div>
    <div class="bar-chart-numbers">
      <div class="bar-chart">
        <h3>Dépenses par catégorie</h3>
        <canvas id="categorySpendingChart"></canvas>
      </div>
      <div class="pie-chart">
        <h3>Statut des commandes</h3>
        <canvas id="orderStatusChart"></canvas>
      </div>
    </div>
  </div>
</main>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('categorySpendingChart').getContext('2d');
    const data = {
      labels: <?= json_encode(array_column($categorySpending, 'category')) ?>,
      datasets: [{
        label: 'Dépenses par catégorie',
        data: <?= json_encode(array_column($categorySpending, 'total_spent')) ?>,
        backgroundColor: [
          'rgba(255, 214, 209, 0.2)',
          'rgba(54, 193, 193, 0.2)',
          'rgba(194, 247, 175, 0.2)',
          'rgba(255, 215, 187, 0.2)',
          'rgba(255, 244, 186, 0.2)',
          'rgba(186, 201, 255, 0.2)'
        ],
        borderColor: [
          'rgba(255, 214, 209, 1)',
          'rgba(54, 193, 193, 1)',
          'rgba(194, 247, 175, 1)',
          'rgba(255, 215, 187, 1)',
          'rgba(255, 244, 186, 1)',
          'rgba(186, 201, 255, 1)'
        ],
        borderWidth: 1
      }]
    };

    const config = {
      type: 'bar',
      data: data,
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    };

    new Chart(ctx, config);

    const ctx1 = document.getElementById('orderStatusChart').getContext('2d');
    const orderStatusCounts = <?= json_encode($orderStatusCounts); ?>;

    const data1 = {
      labels: Object.keys(orderStatusCounts),
      datasets: [{
        label: 'Statut des Commandes',
        data: Object.values(orderStatusCounts),
        backgroundColor: [
          'rgba(255, 214, 209, 0.8)',
          'rgba(194, 247, 175, 0.8)',
          'rgba(255, 215, 187, 0.8)'
        ],
        hoverOffset: 4
      }]
    };

    const config1 = {
      type: 'doughnut',
      data: data1,
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          },
          // title: {
          //   display: true,
          //   text: 'Statut des Commandes'
          // }
        }
      }
    };

    new Chart(ctx1, config1);

  });
</script>
</body>

</html>